{% extends 'base.html' %}

{% block content %}
<div class="row page-titles">
    <div class="col-md-6 col-8 align-self-center">
            <h3 class="text-themecolor m-b-0 m-t-0">Database Export</h3>
            <ol class="breadcrumb">
                <li class="breadcrumb-item"><a href="{% url 'dashboard' %}">Dashboard</a></li>
                <li class="breadcrumb-item">Impex</li>
                <li class="breadcrumb-item active">Export</li>
            </ol>
        </div>
    <div class="col-md-6 col-4 align-self-center">

    </div>
</div>

<div class="card">
    <div class="card-body">
        <div class="row">
            <div class="col-md-12">
                <h4 class="card-title">{% if service.site_mode == 'mammal' %}Pedigree {% else %}Poultry {% endif %} Export Settings</h4>
                <h6 class="card-subtitle"></h6>
                <div class="skin skin-square">
                    <form action="{% url 'export' %}" method="POST" class="form-horizontal" enctype="multipart/form-data">
                        {% csrf_token %}
                        <div class="row pt-3">
                            <div class="col-6">
                                <p>Use the download button on the right to export your Pedigree data.</p>
                            </div>
                            <div class="col-6">
                                <div class="form-group">
                                    <button type="submit" class="btn btn-block btn-info" name="submit" value='csv'>Download .CSV</button>
                                </div>
                            </div>
                        </div>
                    </form>
                </div>
                <table id="resultsTable" class="table table-bordered table-striped">
                    <thead>
                        <tr>
                            <th scope="col" id="generated">Generated by <i class="fad fa-sort text-muted"></i></th>
                            <th scope="col" id="created">Created <i class="fad fa-sort text-muted"></i></th>
                            <th scope="col">State</th>
                            <th scope="col">Action</th>
                        </tr>
                    </thead>
                    <tbody id="resultsTableBody">
                    {% for item in queue_items reversed %}
                        <tr class="results-row" id="{{ item.id }}" complete="{{ item.complete }}">
                            <td>{{ item.user.get_full_name }}</td>
                            <td>{{ item.created }}</td>
                            <td class="complete">{% if item.complete %}<i class="fad fa-check text-success"></i>{% else %}<i class="fas fa-cog fa-spin text-info"></i>{% endif %}</td>
                            <td class="results"><a href="{{ item.download_url }}" target="_blank">
                            <button class="btn btn-info" {% if not item.complete %}disabled{% endif %}>View</button> </a> </td>
                        </tr>
                    {% endfor %}
                    </tbody>
                </table>
            </div>
        </div>
    </div>
</div>



{% endblock %}

{% block footer %}
<script>
    // function called every 10 seconds to update results table
    window.setInterval(function(){
        // iterate through each row of results table
        $('.results-row').each(function (i, row) {
            // ignore if row is complete
            if ($(row).attr('complete') == 'False') {
                // get id of sa queue item
                var itemId = $(row).attr('id');

                // do ajax call to see if item is complete
                $.ajax({
                    url: "{% url 'export_results_complete' %}",
                    type: 'post',
                    headers: {'X-CSRFToken': '{{ csrf_token }}'},
                    dataType: 'text',
                    data: {'item_id': itemId},
                    success: function(data) {
                        result = JSON.parse(data);

                        if (result.result == 'success') {
                            // if item is complete
                            if (result.complete) {
                                // set complete to True for the row
                                $(row).attr('complete', 'True');
                                // change spinning cog to tick
                                $(row).find('td[class*="complete"]').html('<i class="fad fa-check text-success"></i>');
                                // enable the results button
                                $(row).find('td[class*="results"]').html('<a href="' + result.download_url + '"><button class="btn btn-info">View</button> </a> ');
                            }
                        } else {
                            // queue item with the given id doesn't exist
                            errorMsg('failed to update results table');
                        }
                    }
                });
            }
        })
    }, 10000);
</script>
{% endblock %}